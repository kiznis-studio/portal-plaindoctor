---
import Base from '../../layouts/Base.astro';
import { getSpecialtyBySlug, getProvidersBySpecialtyAndState, getProviderCountBySpecialtyAndState, getStateName, formatProviderName } from '../../lib/db';

const path = Astro.params.path || '';
const parts = path.split('/');

// Expected: specialty-slug/state-abbr or specialty-slug/state-abbr/page
if (parts.length < 2) {
  Astro.response.status = 404;
  return Astro.redirect('/404');
}

const specSlug = parts[0];
const stateAbbr = parts[1].toUpperCase();
const page = parts[2] ? parseInt(parts[2]) : 1;
const perPage = 50;

const db = Astro.locals.runtime.env.DB;
const specialty = await getSpecialtyBySlug(db, specSlug);

if (!specialty) {
  Astro.response.status = 404;
  return Astro.redirect('/404');
}

const stateName = getStateName(stateAbbr);
if (stateName === stateAbbr && stateAbbr.length !== 2) {
  Astro.response.status = 404;
  return Astro.redirect('/404');
}

const totalCount = await getProviderCountBySpecialtyAndState(db, specialty.code, stateAbbr);
if (totalCount === 0) {
  Astro.response.status = 404;
  return Astro.redirect('/404');
}

const offset = (page - 1) * perPage;
const providers = await getProvidersBySpecialtyAndState(db, specialty.code, stateAbbr, perPage, offset);
const totalPages = Math.ceil(totalCount / perPage);
---

<Base
  title={`${specialty.name} in ${stateName} — ${totalCount.toLocaleString()} Providers`}
  description={`Find ${totalCount.toLocaleString()} ${specialty.name} providers in ${stateName}. Browse by name with practice address and contact information.`}
  breadcrumbs={[
    { name: 'Home', href: '/' },
    { name: 'Specialties', href: '/specialty' },
    { name: specialty.name, href: `/specialty/${specSlug}` },
    { name: stateName },
  ]}
>
  <section class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-2">{specialty.name} in {stateName}</h1>
    <p class="text-[var(--color-text-secondary)] mb-8">
      {totalCount.toLocaleString()} providers
      {totalPages > 1 && ` — Page ${page} of ${totalPages}`}
    </p>

    <div class="space-y-3">
      {providers.map(p => (
        <a href={`/provider/${p.slug}`} class="block bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg p-4 hover:border-[var(--color-primary)] transition-colors">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-1">
            <div>
              <div class="font-medium">{formatProviderName(p)}</div>
              <div class="text-sm text-[var(--color-text-secondary)]">{p.specialty}</div>
            </div>
            <div class="text-sm text-[var(--color-text-secondary)] sm:text-right">
              <div>{p.city}, {p.state} {p.zip}</div>
              {p.phone && <div>{p.phone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3')}</div>}
            </div>
          </div>
        </a>
      ))}
    </div>

    {totalPages > 1 && (
      <nav class="mt-8 flex justify-center gap-2" aria-label="Pagination">
        {page > 1 && (
          <a href={`/specialty/${specSlug}/${stateAbbr.toLowerCase()}${page === 2 ? '' : '/' + (page - 1)}`}
             class="px-4 py-2 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg hover:border-[var(--color-primary)] text-sm">
            ← Previous
          </a>
        )}
        <span class="px-4 py-2 text-sm text-[var(--color-text-secondary)]">
          Page {page} of {totalPages}
        </span>
        {page < totalPages && (
          <a href={`/specialty/${specSlug}/${stateAbbr.toLowerCase()}/${page + 1}`}
             class="px-4 py-2 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg hover:border-[var(--color-primary)] text-sm">
            Next →
          </a>
        )}
      </nav>
    )}

    <div class="mt-8 p-4 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg text-sm text-[var(--color-text-secondary)]">
      <p>Data from CMS NPPES. PlainDoctor does not rate or rank providers. <a href="/about" class="text-[var(--color-primary)] hover:underline">Learn more</a></p>
    </div>
  </section>
</Base>
